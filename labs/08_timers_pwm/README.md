## Задание 08 "08_timers_pwm"
### Параметры ШИМ
После лекции вы должны быть уже знакомы с Широтно-Импульсной Модуляцией (Pulse Width Modulation).
На лекции упоминалось, что ШИМ применяется во многих сферах,
некоторые из них это регулирование яркости источников света и привод электродвигателей.

<p align="center">
  <img width="700" src="https://github.com/Levitsky-Ilya/stm32f0_ARM/blob/master/docs/images/pwm.png" alt="pwm.png"/>
</p> <p align="center"> Пример сигнала ШИМ

ШИМ представляет из себя прямоугольный сигнал. Кроме очевидных максимального и минимального значения напряжения,
имеются два важных параметра, описывающих форму сигнала: **коэффициент заполнения** и **частота**. 
На картинке приведен пример с различными к.зап.: 10%, 50%, 90%.
Существует ещё **скважность** - **величина обратная коэффициенту заполнения**.
Для справки, в отношении скважности и к.зап. в англоязычной литературе используется только термин **Duty cycle**. 

Хотелось бы отметить, что, интуитивно, для регулировки яркости лампочки частота не имеет большого значения.
Но эта интуиция нарушается в двух крайних случаях.
Частота **очень низкая** перестаёт казаться равномерным горением — человеческий глаз начинает видеть **мерцание**.
Вы могли это наблюдать на лабораторной работе с энкодером. А частота **очень высокая** может снизить яркость горения.
Когда длительность одного импульса становится сравнима с временем задержки цепочки транзисторов, используемых для переключения,
то **форма сигнала искажается**. Кроме того, **большая частота затрачивает бОльшую мощность**.
Поэтому стараются делать частоту чуть выше предела чувствительности глаза.
В электросети естественная частота это 50 Гц, но далеко не для всех глаз этого достаточно.
В данной работе вам выпадет шанс найти свой собственный предел.

### Генерация ШИМ
<p align="center">
  <img width="400" src="https://github.com/Levitsky-Ilya/stm32f0_ARM/blob/master/docs/images/edge.gif" alt="edge.gif"/>
  <img width="400" src="https://github.com/Levitsky-Ilya/stm32f0_ARM/blob/master/docs/images/center.gif" alt="center.gif"/>
</p>
 <p align="center"> Генерация ШИМ с выравниваем по фронту и с выравниванием по центру

Чтобы освежить, как генерируется ШИМ при помощи таймера, взгляните на схемы.
На картинках изображена зависимость значения таймера CNT от времени, а также изображён порог, лежащий в регистре CCR.
ШИМ получается простым вычислением `(CNT >= CCR)`. Если таймер все время растёт и переполняется, то такая ШИМ называется **edge-aligned** PWM.
Если таймер считает вверх/вниз, то получается **center-aligned** PWM.
Заметьте, что **скважность зависит от порога**. Если менять порог, то у `edge-aligned` ШИМ один из фронтов будет неподвижен,
в то время когда у `center-aligned` импульсов не смещается центр.
Глядя на картинку, вы должны обнаружить, что **частота зануления таймера совпадает с частотой ШИМ**. 

### Настройка таймера в режиме генерации ШИМ
Перейдём от теории к практике. Изучите настройку таймера. Сначала идёт настройка выходного канала.

```C
// Тактирование порта А
LL_AHB1_GRP1_EnableClock(LL_AHB1_GRP1_PERIPH_GPIOA);

// Настройка пина А5 в качестве канала CH1 таймера TIM2
LL_GPIO_SetPinMode(GPIOA, LL_GPIO_PIN_5, LL_GPIO_MODE_ALTERNATE);
LL_GPIO_SetAFPin_0_7(GPIOA, LL_GPIO_PIN_5, LL_GPIO_AF_2);
```
Далее начинается настройка самого таймера

```C
// Тактирование таймера
LL_APB1_GRP1_EnableClock(LL_APB1_GRP1_PERIPH_TIM2);

// Частота тактирования делится в 480 раз
LL_TIM_SetPrescaler(TIM2, 479);
// Настройка верхней границы счёта  
LL_TIM_SetAutoReload(TIM2, 999);
```
Если вспомнить предыдущие работы по таймерам, то видно, что таймер отсчитывает каждую сотую миллисекунды.
Каждую сотую секунду таймер переполняется. Это значит, частота ШИМ будет равна 100 Гц.

Далее задаётся тот самый порог, с которым сравнивается текущее значение таймера.

```C
LL_TIM_OC_SetCompareCH1(TIM2, 15); 
```

Эта функция кладёт значение порога в регистр `TIM2_CCR1`.
В этот регистр в режиме `Input Capture` при сигнале с CH1 автоматически запоминалось значение из счётчика таймера `TIM2_CNT`.
А теперь, в режиме `Output Compare (OC)`, наоборот,
регистр со счётчиком постоянно сравнивается с `CCR` и по результатам сравнения регулируется сигнал `CH1`. 

Раз порог равен 15 из 999, то это либо очень маленькая, либо очень большая скважность.
Зависит от «полярности» ШИМ. Полярность выходящего канала задаётся следующей функцией.

```C
LL_TIM_OC_SetPolarity(TIM2, LL_TIM_CHANNEL_CH1, LL_TIM_OCPOLARITY_HIGH);
```
Канал выхода может находится в одном из двух состояний: активном или неактивном.
Что значит "активное сотояное" и определяется функцией выше.
В данном случае аргумент `LL_TIM_OCPOLARITY_HIGH` говорит о том, что активная линия будет с высоким напряжением, а неактивная - с низким (землёй). 
Здесь стоит сказать, что функции `OC_SetPolarity` и `IC_SetPolarity` имеют **похожие названия, но разный смысл**.
**Первая функция определяет напряжение** для активной (и соответственно неактивной) выходящей линии,
в то время как **вторая задаёт по каким фронтам** на входном канале должно просходить событие.

Следующим шагом настраивается поведение `CH1` в зависимости от сравнения TIM2_CCR1 и TIM2_CNT.
Существует множество различных способов управления линией, которые описаны в `stm32f0xx_ll_tim.h`.
Но обращается внимание на следующий способ:


```C
#define LL_TIM_OCMODE_PWM1  (TIM_CCMR1_OC1M_2 | TIM_CCMR1_OC1M_1)                   
/*
 * !<In upcounting, channel y is active as long as TIMx_CNT<TIMx_CCRy else inactive. 
 * In downcounting, channel y is inactive as long as TIMx_CNT>TIMx_CCRy else active.
 */
```
Если присмотреться к описанию, то оно соотвествует происходящему на схеме генерации ШИМ. Выбираем этот аргумент.

```C
LL_TIM_OC_SetMode(TIM2, LL_TIM_CHANNEL_CH1, LL_TIM_OCMODE_PWM1);
```
Затем настраивается счёт вверх.
```C
LL_TIM_SetCounterMode(TIM2, LL_TIM_COUNTERMODE_UP);
```
В связи с этим активным (в данном случае с высоким напряжением) `CH1` будет пока счётчик таймера меньше `15`,
в остальном выход будет неактивен (земля). То есть изначально к.зап. составляет менее 2%.
Тогда ожидается, что интенсивность свечения будет невысока.

В последнюю очередь включается таймер после окончания настройки. При желании также можно организовать прерывание.
```C
// Включение прерываний по событиям на CH1
LL_TIM_EnableIT_CC1(TIM2);
// Включение таймера
LL_TIM_EnableCounter(TIM2);

// Настройка NVIC 
NVIC_EnableIRQ(TIM2_IRQn);
NVIC_SetPriority(TIM2_IRQn, 1);
```

Подключите светодиод к каналу `А5`. Не забудьте про полярность светодиода.
После включения, пронаблюдайте яркость. Измените яркость, выставив другой порог.
Попробуйте изменить частоту, поменяв верхний порог счётчика `TIM2_ARR`.
Вы могли заметить, что после этого действия яркость тоже изменилась.
Яркость определяется в первую очередь отношением `TIM2_CCR1/TIM2_ARR`, которое в точности равно к.зап.
Если необходимо оставлять постоянную скважность при изменяемой частоте, то порог нужно заново пересчитать.

## Самостоятельные задания
Можно менять значения к.зап. и частоты не изменяя код каждый раз, а в реальном времени, и при этом смотреть как меняется характер ШИМ.
Эти величины скорее всего проще менять при помощи энкодера.
Сделайте два таймера, один для управления ШИМ, другой будет обрабатывать энкодер.
В качестве второго таймера можно взять `TIM3`, это таймер близкий `TIM2` по функционалу, только 16-битный.

Предлагается следующий ряд заданий. Некоторые пункты включают в себя предыдущие.
Чем больше заданий вы сможете сделать, тем лучше. Рекомендуется писать функции для перенастройки таймера.
1. **Регулировка к.зап**. После очередного поворота энкодера будет возникать прерывание,
при котором будет значение `TIM3_CCR` будет использовано в качестве нового порога.
Выставьте `TIM3_ARR` равным `TIM2_ARR`, ведь не имеет большого смысла устанавливать порог больше, чем предел счёта таймера `TIM2`.
Каналы `TIM3` отыщите таблице ([stm32f051_family.pdf](https://github.com/edosedgar/stm32f0_ARM/blob/master/docs/stm32f051_family.pdf), стр. 37-38).

2. Переведите к.зап. ШИМ в проценты и выведите на индикатор.

3. Определите порог наблюдаемости мерцания глазом. **Смотрите на светодиод прямо**.

4. Теперь найдите новый порог. Только смотрите на светодиод **боковым взглядом**. Изменился ли результат и в какую сторону?

5. **Регулируйте частоту энкодером**.
Кстати, если вам захочется изменять частоту не линейно, а экспоненциально, как в прошлой лабораторной работе, то есть два пути.
Либо обойтись без `TIM3` и вернуться к старому способу.
Или же значение таймера преобразовать при помощи нелинейной функции наподобие экспоненты.  

6. Выводите частоту (период) на индикатор.

7. Заснимете на камеру смартфона светодиод, когда ШИМ по частоте порядка 60 Герц. Что-то особенное вы наблюдаете? Есть стробоскопический эффект?

8. Организуйте управление и частотой, и скважностью. Переключаться между величинами можно по кнопке. 

## Пьезо-динамик
<p align="center">
  <img width="400" src="https://github.com/Levitsky-Ilya/stm32f0_ARM/blob/master/docs/images/zoomer.jpg" alt="zoomer.jpg"/>
</p>
 <p align="center"> Пьезо-динамик из набора

Если вы организовали переменную частоту, вы *бесплатно* получаете управление звуком. 

Замените светодиод на **пьезо-динамик**. Обратите внимание на полярность! Настройте к. зап. 50% и выберите частоту в районе 400 Гц.
Послушайте результат. 

Работа этого электронного компонента основана на пьезоэффекте.
Суть самого эффекта заключается в некоторых диэлектриках возникает поляризация,
то есть разность потенциалов, если образец механически деформировать.
Есть и обратный эффект: тело механически деформируется при приложении напряжения на него.
Если подать переменное напряжение - образец будет вибрировать в унисон.
Сам пьезо-динамик состоит из пластины пьезоэлектрика с двумя проводящими контактами с двух сторон.
Для увеличения громкости звука к пластине может крепиться небольшой рупор в виде металлического или пластикового купола с отверстием. 

Если подать ШИМ частотой 400 Гц на динамик, то должен быть слышен меандр на той же частоте.
Чисто гармонический сигнал нельзя сгенерировать при помощи только ШИМ,
поэтому кроме основной частоты будут присутствовать гармоники высшего порядка.

### Музыкальная пауза

**Напишите любую мелодию**. Готовые таблицы частот нот и их длительностей можно найти в интернете для многих произведений.
Или же проявите креативность и сочините свой трек. 
