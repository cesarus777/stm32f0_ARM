## Задание 07 "timers_basics"

Таймеры — одна из самых больших и насыщенных тем в курсе.
Таймеров в микроконтроллере много, начиная от базовых таймеров и заканчивая продвинутыми таймерами
и широким диапазоном возможностей.
В рамках этого задания вы познакомитесь с некоторыми возможностями таймера общего назначения `TIM2`.

## Режим счётчика

В данном проекте таймер `TIM2` используется в режиме обычного счетчика.
Регистр-счётчик `TIM2_CNT` является “сердцем” таймера, его бОльшей смысловой частью.
В проекте раз за переполнение счетчика предлагается зажигать/тушить светодиод.

Проанализируем `main.c`. В список заголовочных файлов добавился новый элемент, отвечающий за работу с таймерами:

```C
#include "stm32f0xx_ll_tim.h"
```

Перед использованием таймера его необходимо настроить, как и любую другую периферию. Для настройки служит функция `timers_config`.

Тактирование периферии:

```C
LL_APB1_GRP1_EnableClock(LL_APB1_GRP1_PERIPH_TIM2);
```
Далее устанавливается предделитель (prescaler). Как вы возможно помните, prescaler делит входную частоту тактирования. Значение предделителя записывается в `TIM2_PSC`. Делится так: существует счетчик пределителя, который считает входящие такты. Если он досчитал до значения `PSC`, счетчик пределителя сбрасывается, а таймер отсчитывает следующее значение. Если записать в `TIM2_PSC` значение `0` - таймер будет каждый такт считать. Если записать `n-1` - будет считать каждый n-ый такт. При 48 МГц предделитель `47999` заставляет таймер отсчитывать с частотой 1 кГц.

```C
LL_TIM_SetPrescaler(TIM2, 47999);
```
Затем настраивается значение перезагрузки. Таймер не всегда должен считать до самого переполнения регистра. Можно задать верхнее значение, выше которого таймер считать не будет. По аналогии с предыдущим, поставив в `TIMx_ARR` значение `999`, сброс таймера происходит каждую секунду, если частота самого таймера 1 кГц.

```C
LL_TIM_SetAutoReload(TIM2, 999);
```

У `TIM2` есть три режима счёта: вверх (upcounting mode) и вниз (downcounting mode) и вверх/вниз поочерёдно (center-aligned up/down counting mode). В этом проекте используется первый режим. Счёт производится от `0` до `999`, происходит сброс и счёт идёт заново.

```C
LL_TIM_SetCounterMode(TIM2, LL_TIM_COUNTERMODE_UP);
```

Предлагается изменять состояние светодиода каждый сброс таймера. Поэтому настраивается прерывание:

```C
LL_TIM_EnableIT_UPDATE(TIM2);
```
После настройки таймера его необходимо включить.

```C
LL_TIM_EnableCounter(TIM2);
```
Как разрешить обработку прерываний, вы должны помнить из прошлых примеров.

```C
NVIC_EnableIRQ(TIM2_IRQn);
NVIC_SetPriority(TIM2_IRQn, 0);
```

Для настроенного прерывания, нужен обработчик `TIM2_IRQHandler`. В нем, собственно, организовано обновление светодиода. Но сбрасывается флаг прерывания.

```C
LL_TIM_ClearFlag_UPDATE(TIM2);
```

Не сбросив флаг, программа зациклится в обработчике.

Не забывайте в `main` вызвать настройки всей периферии!

После прошивки микроконтроллера, **светодиод будет мигать с частотой 0.5 Гц** — секунду включен, секунду выключен.
